# Telegram 媒体文件下载器

一个功能强大的Telegram频道媒体文件下载工具，支持多频道并发下载、断点续传、自动重试等特性。

## 主要特性

- 多频道并发下载
  - 支持同时监控多个频道
  - 异步并行下载
  - 智能并发控制，避免过度占用资源
  - 每个频道独立的下载进度管理

- 智能文件管理
  - 支持视频、音频、文档等多种媒体类型
  - 自动过滤大小超限的文件
  - 文件名智能处理，避免特殊字符
  - 原子写入确保文件完整性
  - 音频文件质量比较
    - 支持基于文件大小或比特率的质量判断
    - 自动覆盖低质量文件
    - 可配置最小质量阈值

- 灵活的重试策略
  - 指数退避算法
  - 自动处理网络波动
  - 智能调整重试间隔
  - 失败任务自动重试

- 用户友好的交互
  - 交互式频道选择
  - 实时下载进度显示
  - 详细的状态日志输出
  - 支持优雅退出

## 环境要求

- Python 3.7+
- 必需的Python包：
  - telethon
  - tqdm

## 配置说明

### 1. 环境变量

- `TGDL_DATA_DIR`: 数据存储目录，默认为 `./data`
- `TGDL_DISABLE_TQDM`: 控制下载进度显示方式
  - `false`（默认）：使用tqdm进度条显示下载进度
  - `true`：使用普通日志方式显示进度，每完成10%记录一次，适合在Docker容器等环境中使用
- `TZ`: 时区配置，默认为 `Asia/Shanghai`
  - 支持标准时区格式，如：`Asia/Shanghai`, `America/New_York`, `Europe/London` 等

### 2. 配置文件

首次运行时会自动创建配置文件，需要填写：

- API ID: Telegram API ID
- API Hash: Telegram API Hash
- Phone Number: 你的Telegram手机号
- 媒体类型：需要下载的媒体类型（video/audio/document）
- 代理设置（可选）：
  - 代理类型：支持 socks5、http、mtproxy
  - 代理主机：代理服务器地址
  - 代理端口：代理服务器端口
  - 代理认证：可选的用户名和密码
- 音频质量检查（可选）：
  - 是否启用：yes/no
  - 检查方式：size（文件大小）或 bitrate（比特率）
  - 最小文件大小：启用size检查时的最小文件大小（MB）
  - 最小比特率：启用bitrate检查时的最小比特率（kbps）

### 3. 目录结构

```
data/
├── config/
│   ├── config.json         # 主配置文件
│   └── sessions/           # 会话文件
└── downloads/              # 下载文件存储
```

## 使用方法

### 本地运行
1. 安装依赖：
```bash
pip install -r requirements.txt
```

2. 运行程序：
```bash
python main.py
```

3. 首次运行会要求：
   - 输入Telegram API凭证
   - 选择要下载的频道
   - 指定要下载的媒体类型

4. 程序会自动：
   - 扫描选定频道的新消息
   - 下载符合条件的媒体文件
   - 保存下载进度
   - 处理意外中断的任务

### Docker部署


## 高级特性

### 并发控制
- 异步消息获取和下载
- 智能的并发管理
- 避免过度占用系统资源

### 重试机制
- 初始重试间隔：1秒
- 最大重试间隔：30分钟
- 支持无限重试（可配置最大重试次数）
- 使用指数退避算法
  - 每次重试后延迟时间翻倍
  - 从1秒开始，最大不超过30分钟
  - 连接成功后重置延迟时间
- 智能的重试策略
  - 自动处理网络连接错误
  - 独立管理每个频道的重试状态
  - 优雅降级，避免频繁重试

### 任务恢复
- 自动检测未完成的下载
- 支持断点续传
- 异常退出后可恢复进度
- 保证数据一致性

### 错误处理
- 网络错误自动重试
- 文件损坏检测
- 优雅处理中断信号
- 详细的错误日志

## 注意事项

1. 请确保有足够的存储空间
2. 需要稳定的网络连接
3. 请遵守Telegram的API使用限制
4. 建议使用配置文件管理下载选项

## 常见问题

1. 下载速度慢
   - 检查网络连接
   - 检查并发设置
   - 配置代理服务器：
     - 支持 SOCKS5、HTTP、MTProto 代理
     - 可配置代理认证信息
     - 推荐使用 SOCKS5 代理以获得更好的性能

2. 文件无法下载
   - 确认文件大小是否超限（默认500MB）
   - 检查存储空间
   - 验证媒体类型设置

3. 程序异常退出
   - 查看错误日志
   - 确认配置正确
   - 检查网络状态

## 开发计划

已完成：
- [x] 异步下载架构
- [x] 智能失败处理
- [x] 可配置的重试策略
- [x] 优雅的退出机制
- [x] 音频文件质量检查
- [x] 支持代理配置

计划中：
- [ ] 支持更多媒体类型
- [ ] 添加Web界面
- [ ] 优化存储策略
- [ ] 增加数据统计
- [ ] 支持自定义过滤器
- [ ] 添加下载速度限制
- [ ] 支持自定义文件命名规则